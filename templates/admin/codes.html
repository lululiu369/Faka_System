{% extends "admin/base.html" %}

{% block title %}å…‘æ¢ç ç®¡ç†{% endblock %}

{% block content %}
<div class="page-header">
    <h1>å…‘æ¢ç ç®¡ç†</h1>
    <p>ç”Ÿæˆå’Œç®¡ç†å…‘æ¢ç </p>
</div>

<!-- ç”Ÿæˆå…‘æ¢ç  -->
<div class="card">
    <div class="card-header">
        <h2>ç”Ÿæˆå…‘æ¢ç </h2>
    </div>
    <div class="card-body">
        <form method="POST" action="{{ url_for('admin.generate_codes') }}">
            <div class="flex gap-2" style="flex-wrap: wrap; align-items: flex-end;">
                <div class="form-group" style="flex: 2; min-width: 200px; margin-bottom: 0;">
                    <label>é€‰æ‹©åˆ†ç»„</label>
                    <select name="group_id" class="form-control" required>
                        <option value="">-- è¯·é€‰æ‹©åˆ†ç»„ --</option>
                        {% for group in groups %}
                        <option value="{{ group.id }}" {{ 'selected' if current_group_id==group.id }}>
                            {{ group.name }} (åº“å­˜: {{ group.available_count }})
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group" style="flex: 1; min-width: 120px; margin-bottom: 0;">
                    <label>ç”Ÿæˆæ•°é‡</label>
                    <input type="number" name="count" class="form-control" value="10" min="1" max="1000" required>
                </div>
                <button type="submit" class="btn btn-primary">ç”Ÿæˆ</button>
            </div>
        </form>
    </div>
</div>

<!-- ç­›é€‰ -->
<div class="card">
    <div class="card-header">
        <h2>å…‘æ¢ç åˆ—è¡¨</h2>
        <div class="flex gap-2">
            <a href="{{ url_for('admin.export_codes', group_id=current_group_id or '', status='unused') }}"
                class="btn btn-secondary btn-sm" target="_blank">
                ğŸ“¥ å¯¼å‡ºæœªä½¿ç”¨
            </a>
        </div>
    </div>
    <div class="card-body">
        <form class="filter-bar" method="GET">
            <select name="group_id" onchange="this.form.submit()">
                <option value="">å…¨éƒ¨åˆ†ç»„</option>
                {% for group in groups %}
                <option value="{{ group.id }}" {{ 'selected' if current_group_id==group.id }}>
                    {{ group.name }}
                </option>
                {% endfor %}
            </select>
            <select name="status" onchange="this.form.submit()">
                <option value="">å…¨éƒ¨çŠ¶æ€</option>
                <option value="unused" {{ 'selected' if current_status=='unused' }}>æœªä½¿ç”¨</option>
                <option value="active" {{ 'selected' if current_status=='active' }}>å·²æ¿€æ´»</option>
            </select>
        </form>

        {% if codes %}
        <div class="table-responsive">
            <table>
                <thead>
                    <tr>
                        <th>å…‘æ¢ç </th>
                        <th>åˆ†ç»„</th>
                        <th>çŠ¶æ€</th>
                        <th>æŸ¥çœ‹æ¬¡æ•°</th>
                        <th>é¦–æ¬¡ä½¿ç”¨</th>
                        <th>æœ€è¿‘ä½¿ç”¨</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    {% for code in codes %}
                    <tr>
                        <td style="font-family: 'Roboto Mono', monospace; font-weight: 600;">
                            {{ code.code }}
                            <button class="copy-btn" onclick="copyToClipboard('{{ code.code }}', this)">ğŸ“‹</button>
                        </td>
                        <td>{{ code.group.name if code.group else '-' }}</td>
                        <td>
                            {% if code.status == 'unused' %}
                            <span class="badge badge-success">æœªä½¿ç”¨</span>
                            {% else %}
                            <span class="badge badge-info">å·²æ¿€æ´»</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if code.view_count > 0 %}
                            <span class="badge badge-warning">{{ code.view_count }} æ¬¡</span>
                            {% else %}
                            <span style="color: var(--text-muted);">-</span>
                            {% endif %}
                        </td>
                        <td>{{ code.first_used_at.strftime('%Y-%m-%d %H:%M') if code.first_used_at else '-' }}</td>
                        <td>{{ code.last_used_at.strftime('%Y-%m-%d %H:%M') if code.last_used_at else '-' }}</td>
                        <td>
                            <form method="POST" action="{{ url_for('admin.delete_code', code_id=code.id) }}"
                                style="display: inline;" onsubmit="return confirmDelete()">
                                <button type="submit" class="btn btn-secondary btn-sm"
                                    style="color: var(--danger);">åˆ é™¤</button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p style="color: var(--text-muted); text-align: center; padding: 40px;">
            æš‚æ— å…‘æ¢ç 
        </p>
        {% endif %}
    </div>
</div>
{% endblock %}